#!/usr/bin/env bash

docker exec -i --user postgres globar_db_1 createdb globardb

docker exec -i --user postgres globar_db_1 psql globardb -a  <<__END
create user globar_role password 'j3mc';
__END

docker exec -i globar_db_1 psql -Uglobar_role globardb -a <<__END
drop table if exists vendor_rating;
drop table if exists customers;
drop table if exists vendor;
CREATE OR REPLACE FUNCTION maintain_updated_at()
RETURNS TRIGGER AS \$\$
BEGIN
   NEW.updated_at = now();
   RETURN NEW;
END;
\$\$ language 'plpgsql';

create table customers (
  cust_id int generated by default as identity primary key,
  name text,
  password text,
  email text not null,
  addr_str_num text,
  addr_str_name text,
  addr_city text,
  addr_state text,
  addr_postal text,
  phone text,
  locale text,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);
create trigger cust_updated_at before update
on customers for each row execute procedure
maintain_updated_at();

/* this index ensures that email addresses are unique in the system */
create unique index idx_cust_email on customers(email);

create table vendor (
  vendor_id int generated by default as identity primary key,
  name text not null,
  summary text,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);
create trigger vendor_updated_at before update
on vendor for each row execute procedure
maintain_updated_at();


create table vendor_rating (
  vendor_id int references vendor(vendor_id),
  cust_id int references customers(cust_id),
  rating integer not null,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);
create trigger vendor_rating_updated_at before update
on vendor_rating for each row execute procedure
maintain_updated_at();

/* this is required to support the upsert operation
   and constrains one review per customer per vendor */
create unique index idx_vid_uid on vendor_rating (vendor_id, cust_id);

insert into vendor (vendor_id, name, summary) values
  (1234, 'Toes for Joes', 'We make sure your toes don''t look Dumb and Dumber'),
  (1235, 'Hairspray', 'In business since yesterday, we make sure you don''t die from fumes'),
  (1236, 'Vera''s Butt Wax', 'Your fast track to a smooth butt'),
  (1237, 'War Paint', 'We make sure your face is tastefully decorated for all occaisions');
alter table vendor alter column vendor_id restart with 1300;

insert into customers (cust_id, name, password, email) values
  (37, 'curiousattemptbunny', 'password1', 'curious@gmail.com'),
  (1410, 'bleedingedge', 'password2', 'bleeding@hotmail.com'),
  (2812, 'missyo', 'password3', 'missyo@abc.com');
alter table customers alter column cust_id restart with 2900;

insert into vendor_rating (vendor_id, cust_id, rating) values
  (1234, 37, 3),
  (1234, 1410, 5),
  (1236, 1410, 4),
  (1237, 1410, 4),
  (1237, 2812, 4),
  (1237, 37, 5);
__END
