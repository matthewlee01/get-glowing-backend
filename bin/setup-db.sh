#!/usr/bin/env bash

createdb globardb

psql globardb -a  <<__END
create user globar_role password 'j3mc';
__END

psql -Uglobar_role globardb -a <<__END
drop table if exists vendor_rating;
drop table if exists Customers;
drop table if exists Vendors;
CREATE OR REPLACE FUNCTION maintain_updated_at()
RETURNS TRIGGER AS \$\$
BEGIN
   NEW.updated_at = now();
   RETURN NEW;
END;
\$\$ language 'plpgsql';

create table Customers (
  cust_id int generated by default as identity primary key,
  name_first text,
  name_last text,
  password text,
  email text not null,
  addr_str_num text,
  addr_str_name text,
  addr_city text,
  addr_state text,
  addr_postal text,
  phone text,
  locale text,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);
create trigger cust_updated_at before update
on Customers for each row execute procedure
maintain_updated_at();

/* this index ensures that email addresses are unique in the system */
create unique index idx_cust_email on Customers(email);

create table Vendors (
  vendor_id int generated by default as identity primary key,
  name_first text,
  name_last text,
  password text,
  email text,
  addr_str_num text,
  addr_str_name text,
  addr_city text,
  addr_state text,
  addr_postal text,
  phone text,
  locale text,
  summary text,
  radius int,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);
create trigger vendor_updated_at before update
on Vendors for each row execute procedure
maintain_updated_at();

/* this index ensures that all vendor email addresses are unique in the system */
create unique index idx_ven_email on Vendors(email);

create table vendor_rating (
  vendor_id int references Vendors(vendor_id),
  cust_id int references Customers(cust_id),
  rating integer not null,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null default current_timestamp);
create trigger vendor_rating_updated_at before update
on vendor_rating for each row execute procedure
maintain_updated_at();

/* this is required to support the upsert operation
   and constrains one review per Customer per vendor */
create unique index idx_vid_uid on vendor_rating (vendor_id, cust_id);

insert into Vendors (vendor_id, name_first, name_last, summary, addr_city) values
  (1234, 'Wishful', 'Wanda', 'We make sure your toes don''t look Dumb and Dumber', 'Vancouver'),
  (1235, 'Helen', 'Hairspray', 'In business since yesterday, we make sure you don''t die from fumes', 'Vancouver'),
  (1236, 'Jackie', 'Jones', 'Your fast track to a smooth butt', 'Surrey'),
  (1237, 'Tony', 'Toenails', 'We make sure your face is tastefully decorated for all occaisions', 'Vancouver');
alter table Vendors alter column vendor_id restart with 1300;

insert into Customers (cust_id, name_first, name_last, password, email) values
  (37, 'mr. john', 'dough', 'password1', 'curious@gmail.com'),
  (1410, 'alex', 'attenborough', 'password2', 'bleeding@hotmail.com'),
  (2812, 'nancy', 'drew', 'password3', 'missyo@abc.com');
alter table Customers alter column cust_id restart with 2900;

insert into vendor_rating (vendor_id, cust_id, rating) values
  (1234, 37, 3),
  (1234, 1410, 5),
  (1236, 1410, 4),
  (1237, 1410, 4),
  (1237, 2812, 4),
  (1237, 37, 5);
__END
